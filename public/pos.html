<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Authenticus POS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      text-align: center;
      padding: 40px;
    }

    h1 {
      color: #f5c542;
      margin-bottom: 10px;
    }

    .menu {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 30px;
    }

    .item {
      background: #f5c542;
      color: #111;
      border: none;
      border-radius: 10px;
      padding: 15px 25px;
      font-size: 18px;
      cursor: pointer;
      transition: 0.2s;
    }

    .item:hover {
      transform: scale(1.05);
    }

    #order {
      max-width: 520px;
      margin: 0 auto;
      background: #222;
      border-radius: 12px;
      padding: 15px;
      text-align: left;
    }

    #order h2 {
      text-align: center;
      color: #f5c542;
    }

    .totals {
      margin-top: 10px;
      line-height: 1.4;
    }
    .totals span {
      color: #f5c542;
    }

    .email-block {
      max-width: 520px;
      margin: 15px auto 0;
      text-align: left;
    }

    .email-block label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .email-block input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #444;
      font-size: 16px;
      box-sizing: border-box;
    }

    #status {
      margin-top: 25px;
      font-size: 18px;
      min-height: 25px;
    }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 15px 25px;
      font-size: 18px;
      cursor: pointer;
      margin: 10px;
      transition: 0.2s;
    }

    #charge { background: #28a745; color: #fff; }
    #charge:hover { background: #34c759; }

    #cancel { background: #e63946; color: #fff; }
    #cancel:hover { background: #ff4d4d; }

    #clear { background: #444; color: #fff; }
    #clear:hover { background: #666; }
  </style>
</head>
<body>
  <h1>Authenticus POS</h1>
  <p>Select services to add to order:</p>

  <div class="menu">
    <button class="item" onclick="addItem('Studio Walkthrough', 25000)">Studio Walkthrough ‚Äì $250</button>
    <button class="item" onclick="addItem('White Frame 3D Model ‚Äì $750', 75000)">White Frame 3D Model ‚Äì $750</button>
    <button class="item" onclick="addItem('White Frame 3D Model ‚Äì $850', 85000)">White Frame 3D Model ‚Äì $850</button>
    <button class="item" onclick="addItem('White Frame 3D Model ‚Äì $1000', 100000)">White Frame 3D Model ‚Äì $1000</button>
    <button class="item" onclick="addItem('White Frame 3D Model ‚Äì $1250', 125000)">White Frame 3D Model ‚Äì $1250</button>
    <button class="item" onclick="addItem('test', 100)">test ‚Äì $1</button>
  </div>

  <div id="order">
    <h2>Current Order</h2>
    <ul id="orderList"></ul>

    <div class="totals">
      <p>Subtotal: $<span id="subtotal">0.00</span></p>
      <p>Tax (8.25%): $<span id="tax">0.00</span></p>
      <p><strong>Total: $<span id="total">0.00</span></strong></p>
    </div>
  </div>

  <!-- Optional email for receipt -->
  <div class="email-block">
    <label for="email">Customer Email (optional for receipt):</label>
    <input type="email" id="email" placeholder="name@example.com" />
  </div>

  <div>
    <button class="btn" id="charge" onclick="charge()">üí≥ Charge Customer</button>
    <button class="btn" id="cancel" onclick="cancelPayment()">üö´ Cancel Payment</button>
    <button class="btn" id="clear" onclick="clearOrder()">Clear Order</button>
  </div>

  <div id="status"></div>

  <script>
    const BASE_URL = window.location.origin;
    const TAX_RATE = 0.0825; // Texas Sales Tax 8.25%
    let order = [];

    function addItem(name, price) {
      const existing = order.find(i => i.name === name);
      if (existing) existing.qty++;
      else order.push({ name, price, qty: 1 });
      updateOrder();
    }

    function clearOrder() {
      order = [];
      updateOrder();
      document.getElementById("status").innerHTML = "";
      document.getElementById("email").value = "";
    }

    function updateOrder() {
      const list = document.getElementById("orderList");
      const subtotalEl = document.getElementById("subtotal");
      const taxEl = document.getElementById("tax");
      const totalEl = document.getElementById("total");

      list.innerHTML = "";
      let subtotal = 0;

      order.forEach(item => {
        const li = document.createElement("li");
        li.textContent = `${item.name} √ó${item.qty} ‚Äì $${(item.price * item.qty / 100).toFixed(2)}`;
        list.appendChild(li);
        subtotal += item.price * item.qty;
      });

      const tax = Math.round(subtotal * TAX_RATE);
      const total = subtotal + tax;

      subtotalEl.textContent = (subtotal / 100).toFixed(2);
      taxEl.textContent = (tax / 100).toFixed(2);
      totalEl.textContent = (total / 100).toFixed(2);
    }

    async function charge() {
      const status = document.getElementById("status");
      let subtotal = order.reduce((sum, i) => sum + i.price * i.qty, 0);
      if (subtotal === 0) {
        status.innerHTML = "‚ùå Add at least one service.";
        return;
      }

      const tax = Math.round(subtotal * TAX_RATE);
      const total = subtotal + tax;

      // Optional email
      const emailInput = document.getElementById("email").value.trim();
      const email = emailInput.length ? emailInput : undefined;

      status.innerHTML = `Creating payment for $${(total / 100).toFixed(2)}...`;

      try {
        // Build payload, only include email if present
        const payload = {
          amount: total,
          currency: "usd",
          metadata: { items: JSON.stringify(order) }
        };
        if (email) {
          payload.email = email;
        }

        const intentRes = await fetch(`${BASE_URL}/create-payment-intent`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await intentRes.json();
        if (!data.payment_intent) throw new Error(data.error || "Failed to create payment intent");

        status.innerHTML = "Processing payment on WisePOS reader...";
        const processRes = await fetch(`${BASE_URL}/process-on-reader`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ payment_intent: data.payment_intent })
        });

        const result = await processRes.json();

        if (result.success) {
          status.innerHTML = `‚úÖ Payment of $${(total / 100).toFixed(2)} succeeded!`;
          clearOrder();
        } else {
          throw new Error(result.error || "Payment failed");
        }
      } catch (err) {
        status.innerHTML = `‚ùå Error: ${err.message}`;
      }
    }

    async function cancelPayment() {
      const status = document.getElementById("status");
      status.innerHTML = "Cancelling payment on reader...";
      try {
        const res = await fetch(`${BASE_URL}/cancel-payment`, { method: "POST" });
        const data = await res.json();
        if (data.success) {
          status.innerHTML = "üö´ Payment cancelled on reader.";
        } else {
          status.innerHTML = `‚ö†Ô∏è Could not cancel: ${data.error || 'Unknown error'}`;
        }
      } catch (err) {
        status.innerHTML = `‚ùå Cancel error: ${err.message}`;
      }
    }
  </script>
</body>
</html>
