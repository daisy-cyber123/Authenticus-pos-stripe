<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Authenticus POS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#fff; text-align:center; padding:40px; }
    h1 { color:#f5c542; margin-bottom:10px; }
    .menu { display:flex; justify-content:center; flex-wrap:wrap; gap:15px; margin-bottom:30px; }
    .item { background:#f5c542; color:#111; border:none; border-radius:10px; padding:15px 25px; font-size:18px; cursor:pointer; transition:0.2s; }
    .item:hover { transform:scale(1.05); }
    #order { max-width:520px; margin:0 auto; background:#222; border-radius:12px; padding:15px; text-align:left; }
    #order h2 { text-align:center; color:#f5c542; }
    #status { margin-top:25px; font-size:18px; }
    #charge { margin-top:25px; background:#28a745; color:#fff; border:none; border-radius:10px; padding:15px 25px; font-size:20px; cursor:pointer; transition:0.2s; }
    #charge:hover { background:#34c759; }
    #clear { background:#444; color:#fff; border:none; border-radius:10px; padding:10px 20px; margin-top:10px; cursor:pointer; }
    #cancel { background:#f54242; color:#fff; border:none; border-radius:10px; padding:10px 20px; margin-top:10px; cursor:pointer; }
    #cancel:hover { background:#ff5c5c; }
  </style>
</head>
<body>
  <h1>Authenticus POS</h1>
  <p>Select services to add to order:</p>

  <div class="menu">
    <button class="item" onclick="addItem('Studio Walkthrough', 25000)">Studio Walkthrough ‚Äì $250</button>
    <button class="item" onclick="addItem('White Frame 3D Model ‚Äì $750', 75000)">White Frame 3D Model ‚Äì $750</button>
    <button class="item" onclick="addItem('White Frame 3D Model ‚Äì $850', 85000)">White Frame 3D Model ‚Äì $850</button>
    <button class="item" onclick="addItem('White Frame 3D Model ‚Äì $1000', 100000)">White Frame 3D Model ‚Äì $1000</button>
    <button class="item" onclick="addItem('White Frame 3D Model ‚Äì $1250', 125000)">White Frame 3D Model ‚Äì $1250</button>
    <button class="item" onclick="addItem('Initiate Package', 190000)">Initiate Package ‚Äì $1900</button>
  </div>

  <div id="order">
    <h2>Current Order</h2>
    <ul id="orderList"></ul>
    <p><strong>Total: $<span id="total">0.00</span></strong></p>
  </div>

  <button id="charge" onclick="charge()">üí≥ Charge Customer</button>
  <button id="cancel" onclick="cancelReader()">üßπ Cancel on Reader</button>
  <button id="clear" onclick="clearOrder()">Clear Order</button>
  <div id="status"></div>

  <script>
    const BASE_URL = window.location.origin;
    let order = [];

    function addItem(name, price) {
      const existing = order.find(i => i.name === name);
      if (existing) existing.qty++;
      else order.push({ name, price, qty: 1 });
      updateOrder();
    }

    function clearOrder() {
      order = [];
      updateOrder();
      document.getElementById("status").innerHTML = "";
    }

    function updateOrder() {
      const list = document.getElementById("orderList");
      const totalDisplay = document.getElementById("total");
      list.innerHTML = "";
      let total = 0;
      order.forEach(item => {
        const li = document.createElement("li");
        li.textContent = `${item.name} √ó${item.qty} ‚Äì $${(item.price * item.qty / 100).toFixed(2)}`;
        list.appendChild(li);
        total += item.price * item.qty;
      });
      totalDisplay.textContent = (total / 100).toFixed(2);
    }

    async function charge() {
      const status = document.getElementById("status");
      const total = order.reduce((sum, i) => sum + i.price * i.qty, 0);
      if (total === 0) {
        status.innerHTML = "‚ùå Add at least one service.";
        return;
      }

      status.innerHTML = `Creating payment for $${(total / 100).toFixed(2)}...`;
      try {
        const intentRes = await fetch(`${BASE_URL}/create-payment-intent`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: total,
            currency: "usd",
            metadata: { items: JSON.stringify(order) }
          })
        });
        const data = await intentRes.json();
        if (!data.payment_intent) throw new Error(data.error || "Failed to create payment intent");

        status.innerHTML = "Processing payment on WisePOS reader...";
        const processRes = await fetch(`${BASE_URL}/process-on-reader`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ payment_intent: data.payment_intent })
        });
        const result = await processRes.json();

        if (result.success) {
          status.innerHTML = `‚úÖ Payment of $${(total / 100).toFixed(2)} succeeded!`;
          clearOrder();
        } else {
          throw new Error(result.error || "Payment failed");
        }
      } catch (err) {
        status.innerHTML = `‚ùå Error: ${err.message}`;
      }
    }

    async function cancelReader() {
      const status = document.getElementById("status");
      status.innerHTML = "Cancelling current reader action...";
      try {
        const cancelRes = await fetch(`${BASE_URL}/cancel-reader`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        const result = await cancelRes.json();
        if (result.success) {
          status.innerHTML = "‚úÖ Reader reset to idle.";
        } else {
          throw new Error(result.error || "Cancel failed");
        }
      } catch (err) {
        status.innerHTML = `‚ùå Error: ${err.message}`;
      }
    }
  </script>
</body>
</html>
